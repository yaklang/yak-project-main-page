(window.webpackJsonp=window.webpackJsonp||[]).push([["55f14c389d78","de20b5688127"],{vb116:function(e,r,t){"use strict";t.r(r);var n=t("vb56"),s=t.n(n),i=t("vb253"),o=t.n(i),a=t("vb64"),d=t.n(a),c=t("vb234"),u=t.n(c),l=t("vb235"),f=t.n(l),v=t("vb140"),h=t("vb114"),b=t("vb53"),p={},y={},m=50,g=8e3,U=2e3,k=8e3;function E(e){return p[e]}function O(e){p[e]=(p[e]||0)+1}function T(e,r){y[e]=r}function _(e){return!!y[e]}function F(e){return Object(h.isUserFieldType)(e)||e===h.FieldType.Text||e===h.FieldType.DateTime}var P="MentionPermissionManager",w="PERMISSION_CHANGE_KEY",M="CHECK_USER_AVATAR_KEY",I=function(){function n(e,r){var t=this;u()(this,n),this.needLoadUserIds=new Set,this.batchFetchUsersArr=[],this.batchFetchOnlyLoadAvatarUsersArr=[],this.isFetchingAvatar=!1,this.batchUpdateFaster=Object(v.a)(function(){t.renderer.updateFaster()},U,{maxWait:k,trailing:!0}),this.batchFetchUsersPemission=function(e){t.needLoadUserIds.add(e),t.fetchUserPermission()},this.fetchUserPermission=Object(v.a)(function(){t.userPermissionManager.addUsers(Array.from(t.needLoadUserIds)),t.needLoadUserIds.clear()},500),this.renderer=e,this.bitableStore=r,this.userPermissionManager=new b.UserPermissionManager({onPermissionChange:function(e){var r=t.renderer.getActiveTable();r&&Object.keys(r.records).forEach(function(e){r.updateRecordVersionMap(e)}),t.batchUpdateFaster(),b.EventEmitter.emit(w,e)},onError:function(e){console.error(e)}})}return f()(n,[{key:"getFieldWhichHasUsers",value:function(e){var r=[];for(var t in e.fields){var n=e.fields[t];F(n.type)&&r.push(n)}return r}},{key:"checkUserToken",value:function(e){return e.type===h.SegmentType.Mention&&e.mentionType===h.MentionType.User&&!Number.isNaN(Number(e.token))}},{key:"initUsers",value:function(){var a=this,s=this.renderer.getActiveTable();if(s){var e=this.getFieldWhichHasUsers(s),o=new Set,n=new Set,c=function(e,r){var t=s.getUserItemById(e);a.bitableStore.addUserWatch(e,s.id,r),(!t||t.avatarUrl&&h.filterUserUrls.some(function(e){return t.avatarUrl.includes(e)}))&&(_(e)||n.add(e))},r=function(i){s.records[i]&&e.forEach(function(t){if(t.type===h.FieldType.Text){var e=s.getCellValue(i,t.id);Array.isArray(e)&&e.forEach(function(e){a.checkUserToken(e)&&(o.add(e.token),c(e.token,t.id))})}else if(t.type===h.FieldType.User){var r=s.getCellValue(i,t.id);r&&Array.isArray(r.users)&&r.users.forEach(function(e){o.add(e.userId),c(e.userId,t.id)})}else if(t.type===h.FieldType.CreatedUser||t.type===h.FieldType.ModifiedUser){t.getUserIds(s,i,t.id).forEach(function(e){o.add(e),c(e,t.id)})}else if(t.type===h.FieldType.DateTime){var n=s.getReminder(i,t.id);n&&n.notifyEntities.users&&n.notifyEntities.users.forEach(function(e){var r=e.userId;o.add(r),c(r,t.id)})}})};for(var t in s.records)r(t);this.fetchUsers(s,Array.from(n)),this.addUsers(Array.from(o))}}},{key:"fetchUsers",value:function(c,e){var u=this,r=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(e.length){var i=[],a=function(s){var o=1<arguments.length&&void 0!==arguments[1]&&arguments[1];return u.userPermissionManager.fetchUsers(s).then(function(e){var r=e.payload||{},t=r.entities,i=void 0===t?{}:t,n=r.result_list,a=[];return((void 0===n?[]:n)||[]).forEach(function(e){var r=i[e],t=c.getUserItemById(e),n={userId:e,name:r.cn_name,enName:r.en_name,avatarUrl:r.avatar_url};if(!o&&r.avatar_url)return c.setUserItem(n,!0,o),void u.bitableStore.triggerTableRerenderWhenUserLoad(e);r.avatar_url&&t&&t.avatarUrl!==r.avatar_url&&a.push(e),c.setUserItem(n,!0,o)}),u.addUsers(s),a}).finally(function(){s.forEach(function(e){T(e,!1)})})};e.forEach(function(e){T(e,!0),r?u.batchFetchOnlyLoadAvatarUsersArr.push(e):u.batchFetchUsersArr.push(e)}),Promise.resolve().then(function(){for(;u.batchFetchUsersArr.length;){var e=u.batchFetchUsersArr.splice(0,m);a(e)}}),this.isFetchingAvatar||(this.isFetchingAvatar=!0,setTimeout(d()(s.a.mark(function e(){var r,t,n;return s.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=o()(u.batchFetchOnlyLoadAvatarUsersArr),u.batchFetchOnlyLoadAvatarUsersArr=[],r=[];case 3:if(!i.length){e.next=18;break}return t=i.splice(0,m),e.prev=5,e.next=8,a(t,!0);case 8:(n=e.sent)&&n.length&&r.push.apply(r,o()(n)),e.next=16;break;case 12:throw e.prev=12,e.t0=e.catch(5),u.isFetchingAvatar=!1,Error(e.t0);case 16:e.next=3;break;case 18:u.isFetchingAvatar=!1,r.forEach(function(e){u.bitableStore.triggerTableRerenderWhenUserLoad(e)});case 20:case"end":return e.stop()}},e,null,[[5,12]])})),g))}}},{key:"addUsers",value:function(e){this.userPermissionManager.addUsers(e),this.bindCellRenderMiddleWare()}},{key:"addUserByAction",value:function(e){var r=this;if(e.action===h.DataActionNames.SetRecord){var t=e.data,n=new Set;for(var i in t){var a=t[i],s=a.type,o=a.value;if(o)if(s===h.FieldType.Text&&Array.isArray(o))o.forEach(function(e){r.checkUserToken(e)&&n.add(e.token)});else if(s===h.FieldType.User&&Array.isArray(o.users))o.users.forEach(function(e){n.add(e.userId)});else if(s===h.FieldType.DateTime){var c=a.reminders&&a.reminders.reminder;c&&c.notifyEntities.users&&c.notifyEntities.users.forEach(function(e){n.add(e.userId)})}}this.userPermissionManager.addUsers(Array.from(n))}}},{key:"setUserItemWithPermission",value:function(e,r,t,n,i){var a=!(5<arguments.length&&void 0!==arguments[5])||arguments[5];e.getUserItemById(r)||(i?e.setUserItem(i):_(r)||E(r)&&!(E(r)<3)||(a&&e.markDirtyForField(t,n),this.fetchUsers(e,[r]),this.addUsers([r]),O(r)));var s=this.userPermissionManager.getPermissionByUser(r);s?e.setUserPermission(r,s):this.batchFetchUsersPemission(r)}},{key:"checkUserPermission",value:function(e,t,n,r,i){var a=this,s=t.fields[n];if(!s)return e;var o=s.type,c=e,u=Object(h.getProxyFieldAndValue)(s,e);return u.proxy&&(s=u.field,c=u.value,o=s.type),o===h.FieldType.Text&&Array.isArray(c)?c.forEach(function(e){var r;e.type===h.SegmentType.Mention&&e.mentionType===h.MentionType.User&&(e.name&&e.en_name&&(r={userId:e.token,name:e.name,enName:e.en_name,avatarUrl:e.link}),a.setUserItemWithPermission(t,e.token,n,i,r))}):Object(h.isUserFieldType)(o)&&c&&Array.isArray(c.users)&&c.users.forEach(function(e){a.setUserItemWithPermission(t,e.userId,n,i)}),e}},{key:"checkUserAvatar",value:function(e,r,t,n,i){var a=this,s=r.fields[t];if(!s)return e;var o=s.type,c=e;if(Object(h.isUserFieldType)(o)&&c&&Array.isArray(c.users)){var u=c.users.map(function(e){return e.userId});u.forEach(function(e){a.bitableStore.addUserWatch(e,r.id,t)});var d=u.filter(function(e){return _(e)||r.checkUserInfo(e)?null:e});if(!d.length)return e;this.fetchUsers(r,d,!0)}return e}},{key:"bindCellRenderMiddleWare",value:function(){var e=this.renderer.activeBitableWidget;e&&(e.middleWare.setMiddleware(P,this.checkUserPermission.bind(this)),e.middleWare.setMiddleware(M,this.checkUserAvatar.bind(this)))}},{key:"reset",value:function(){this.userPermissionManager.destroy();var e=this.renderer.activeBitableWidget;e&&(e.middleWare.removeMiddleware(P),e.middleWare.removeMiddleware(M))}},{key:"addPermissionChangeListener",value:function(e){b.EventEmitter.on(w,e)}},{key:"removePermissionChangeListener",value:function(e){b.EventEmitter.off(w,e)}}]),n}(),j=function(){function e(){u()(this,e),this.userValidMap={}}return f()(e,[{key:"setUserItemValid",value:function(e){this.userValidMap[e]={isValid:!0}}},{key:"checkUserInfo",value:function(e){var r=!1;return e&&this.userValidMap[e]&&(r=this.userValidMap[e].isValid),r}},{key:"init",value:function(){this.userValidMap={}}}]),e}(),S=t("vb269"),C=t("vb314");function W(e){Object(b.injectBitableDep)(e),h.BitableGlobalConfig.setGlobalConfig({UserManagerHelper:{MentionPermissionManager:I,UserValidationManager:new j},config:{cardSyncMode:h.CardSyncMode.RealTime},collectBitableEvent:S.b,GzipWorker:new C.a})}t.d(r,"default",function(){return W})},vb153:function(e,r,t){var n=t("vb316"),i=t("vb258"),a=n.t;e.exports=function(){var e=a.apply(null,arguments);return i(e)}},vb258:function(e,r,t){var n=t("vb259").getAppNameFromConfig;e.exports=function(e){var r=n();return e.replace(/\{\{APP_DISPLAY_NAME\}\}/g,r)}},vb259:function(e,b,p){"use strict";p.r(b),function(e){p.d(b,"getAppNameFromConfig",function(){return l});var r,t,n,i,a,s=p("vb136"),o=p("vb52"),c=null,u="undefined"==typeof window?e:window,d=(r={zh:"zh-CN",en:"en-US",ja:"ja-JP",fr:"fr-FR",hi:"hi-IN",id:"id-ID",it:"it-IT",ko:"ko-KR",pt:"pt-BR",ru:"ru-RU",th:"th-TH",vi:"vi-VN",de:"de-DE",es:"es-ES","zh-TW":"zh-TW","zh-HK":"zh-HK"},t=Object(o.a)(u,"User.language"),n=Object(o.a)(u,"navigator.language"),a=(i=t||n||"").split("-")[0],r[i]||r[a]||"en-US");function l(){if(null!==c)return c;var e="Lark";try{var r=u.globalConfig?u.globalConfig.common:u.backupDomain.ext,t="common."+Object(o.a)(r,"brand.app_name","").toLowerCase(),n=u.TTI18N[t];n&&(e=n)}catch(e){}return c=f()||v()||h()||e}function f(){var e=u.globalKaConfig;if(e){var r=Object(o.a)(e,"i18n.IDS_LARK_PRODUCT_NAME");return Object(s.a)(r)?r:""}}function v(){var e=u.globalKaConfig;if(e){var r=Object(o.a)(e,"i18n.app_name.$base","");return Object(o.a)(e,"i18n.app_name[".concat(d,"]"),r)}}function h(){if(u.materialConfig)return u.materialConfig.brand_app_name}}.call(this,p("vb78"))},vb269:function(e,r,t){"use strict";t.d(r,"a",function(){return y}),t.d(r,"b",function(){return s});var n=t("vb60"),i=t.n(n),f=t("vb52"),v=t("vb53"),h=t("vb114");function a(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function b(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?a(Object(t),!0).forEach(function(e){i()(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}var p=Object(v.getAllUrlParams)().localhost,y={eventMap:null},s=function(e){var r,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if((Object(f.a)(window,"local.localhost")||p)&&console.log("collectBitableEvent",e,t),y.eventMap&&0<Object.keys(y.eventMap).length&&(r=y.eventMap[e]),Object(v.collectSuiteEvent)(e,b({is_bitable:!0},t,{},r)),n&&t.bitable_view_type){var i=t.smartable_token,a=t.row,s=t.col,o=t.table_id,c=t.bitable_view_type,u=t.bitable_field_type,d=t.view_id,l={is_bitable:!0,bitable_view_type:c};void 0!==i&&(l.smartable_token=i,l.bitable_id=i),void 0!==a&&(l.row=a),void 0!==s&&(l.col=s),void 0!==o&&(l.table_id=o),void 0!==u&&(l.bitable_field_type=u),void 0!==d&&(l.view_id=d),Object(v.collectSuiteEvent)(h.LogEvent.ClientFielBitableEdit,l)}}},vb321:function(e,r){},vb419:function(e,r,t){"use strict";t.d(r,"a",function(){return d});var n=t("vb253"),i=t.n(n),a=t("vb379"),s=t("vb130");function o(e){return JSON.parse(a.a.ungzip(s.Buffer.from(e,"base64"),{to:"string"}))}function c(e){return s.Buffer.from(a.a.gzip(JSON.stringify(e),{level:9})).toString("base64")}var u={ungzip:o,gzip:c},d=function(e){var r=u[e.method];if(r)return r.apply(void 0,i()(e.args))}}}]);
//# sourceMappingURL=//slardar.bytedance.net/api_v2/browser/jserr/get_sourcemap?bid=docs_pc&js_filename=vb_bitableInjectBitableDep.b48d5da949.chunk.js